import { describe, expect, it } from 'vitest'
import { createResolver } from '@nuxt/kit'
import { $fetch, setup } from '@nuxt/test-utils'

const { resolve } = createResolver(import.meta.url)

await setup({
  rootDir: resolve('../.playground'),
  build: true,
  server: true,
  nuxtConfig: {
    sitemap: {
      autoLastmod: false,
      siteUrl: 'https://nuxt-simple-sitemap.com',
    },
  },
})
describe('prod', () => {
  it('basic', async () => {
    const sitemapIndex = await $fetch('/sitemap_index.xml')

    // test that we have 2 sitemap entries using regex
    expect(sitemapIndex.match(/<sitemap>/g)!.length).toBe(2)

    expect(sitemapIndex).toMatchInlineSnapshot(`
      "<?xml version=\\"1.0\\" encoding=\\"UTF-8\\"?><?xml-stylesheet type=\\"text/xsl\\" href=\\"/__sitemap__/style.xsl\\"?>
      <sitemapindex xmlns=\\"http://www.sitemaps.org/schemas/sitemap/0.9\\">
          <sitemap>
              <loc>https://nuxt-simple-sitemap.com/posts-sitemap.xml</loc>
          </sitemap>
          <sitemap>
              <loc>https://nuxt-simple-sitemap.com/pages-sitemap.xml</loc>
              <lastmod>2023-02-21T08:50:52+00:00</lastmod>
          </sitemap>
      </sitemapindex>
      <!-- XML Sitemap generated by Nuxt Simple Sitemap -->"
    `)

    expect(await $fetch('/posts-sitemap.xml')).toMatchInlineSnapshot(`
      "<?xml version=\\"1.0\\" encoding=\\"UTF-8\\"?><?xml-stylesheet type=\\"text/xsl\\" href=\\"/__sitemap__/style.xsl\\"?>
      <urlset xmlns:xsi=\\"http://www.w3.org/2001/XMLSchema-instance\\" xmlns:image=\\"http://www.google.com/schemas/sitemap-image/1.1\\" xsi:schemaLocation=\\"http://www.sitemaps.org/schemas/sitemap/0.9 http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd http://www.google.com/schemas/sitemap-image/1.1 http://www.google.com/schemas/sitemap-image/1.1/sitemap-image.xsd\\" xmlns=\\"http://www.sitemaps.org/schemas/sitemap/0.9\\">
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/tags</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-1</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-2</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-3</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-4</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-5</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-6</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-7</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-8</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-9</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-10</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-11</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-12</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-13</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-14</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-15</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-16</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-17</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-18</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-19</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-20</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-21</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-22</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-23</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-24</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-25</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-26</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-27</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-28</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-29</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-30</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-31</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-32</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-33</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-34</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-35</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-36</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-37</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-38</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-39</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-40</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-41</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-42</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-43</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-44</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-45</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-46</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-47</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-48</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-49</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/post-50</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/blog/categories</loc>
          </url>
      </urlset>
      <!-- XML Sitemap generated by Nuxt Simple Sitemap -->"
    `)

    expect(await $fetch('/pages-sitemap.xml')).toMatchInlineSnapshot(`
      "<?xml version=\\"1.0\\" encoding=\\"UTF-8\\"?><?xml-stylesheet type=\\"text/xsl\\" href=\\"/__sitemap__/style.xsl\\"?>
      <urlset xmlns:xsi=\\"http://www.w3.org/2001/XMLSchema-instance\\" xmlns:image=\\"http://www.google.com/schemas/sitemap-image/1.1\\" xsi:schemaLocation=\\"http://www.sitemaps.org/schemas/sitemap/0.9 http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd http://www.google.com/schemas/sitemap-image/1.1 http://www.google.com/schemas/sitemap-image/1.1/sitemap-image.xsd\\" xmlns=\\"http://www.sitemaps.org/schemas/sitemap/0.9\\">
          <url>
              <loc>https://nuxt-simple-sitemap.com</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/about</loc>
              <image:image>
                  <image:loc>https://example.com/image.jpg</image:loc>
              </image:image>
              <image:image>
                  <image:loc>https://example.com/image2.jpg</image:loc>
              </image:image>
              <image:image>
                  <image:loc>https://example.com/image-3.jpg</image:loc>
              </image:image>
              <lastmod>2023-02-21T01:50:52.000Z</lastmod>
              <changefreq>daily</changefreq>
              <priority>0.3</priority>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/new-page</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/users-lazy/1</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/users-lazy/2</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/users-lazy/3</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/users-prerender</loc>
          </url>
          <url>
              <loc>https://nuxt-simple-sitemap.com/hidden-path-but-in-sitemap</loc>
          </url>
      </urlset>
      <!-- XML Sitemap generated by Nuxt Simple Sitemap -->"
    `)
  }, 60000)
})
